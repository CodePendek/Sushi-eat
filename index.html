<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sushi Eat - Digital Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Quicksand', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #FCF8F5;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        
        .category-chip.active {
            background: #ea580c; color: white; border-color: #ea580c;
            box-shadow: 0 8px 15px -3px rgba(234, 88, 12, 0.3);
        }

        #lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        #lightbox.active { display: flex; }
        #lightbox img { 
            max-width: 100%; max-height: 70vh; 
            border-radius: 20px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        .fade-in { animation: fadeIn 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800">

    <div id="lightbox" onclick="handleBack()">
        <img id="lightbox-img" src="" onclick="event.stopPropagation()">
    </div>

    <div id="splash-screen" class="fixed inset-0 z-[100] bg-white flex items-center justify-center transition-opacity duration-700">
        <img src="img/logo.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2252/2252439.png'" class="w-32 animate-pulse">
    </div>

    <nav class="fixed top-0 w-full z-40 glass border-b border-orange-100/50 px-6 h-16 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <img src="img/logo-2.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2252/2252439.png'" class="w-8 h-8">
            <span class="font-bold text-xl tracking-tight uppercase">Sushi<span class="text-orange-600">Eat</span></span>
        </div>
        <button onclick="toggleSearch()" class="p-2.5 bg-slate-100 rounded-full text-slate-600 active:scale-90 transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </button>
    </nav>

    <div id="search-container" class="fixed top-16 left-0 w-full glass -translate-y-full opacity-0 pointer-events-none border-b border-orange-100 shadow-xl z-30 transition-all duration-300">
        <div class="p-4">
            <input type="text" id="search-input" oninput="searchMenu()" placeholder="Cari menu favoritmu..." 
                class="w-full bg-white border border-slate-200 rounded-xl py-3 px-5 focus:outline-none focus:ring-2 focus:ring-orange-500 font-medium">
        </div>
    </div>
    
    <main id="swipe-area" class="pt-20 pb-40">
        <div id="tab-container" class="flex gap-3 overflow-x-auto no-scrollbar px-6 mb-6 sticky top-[64px] z-20 py-3 bg-[#FCF8F5]/95"></div>
        <div id="menu-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 px-6"></div>
    </main>

    <div id="bottom-bar" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-md z-40 translate-y-32 opacity-0 transition-all duration-500">
        <div class="bg-slate-900 rounded-3xl p-2 flex items-center justify-between shadow-2xl border border-white/10">
            <div class="flex flex-col ml-6 text-white">
                <span id="cart-count-label" class="text-[10px] text-slate-400 font-bold uppercase">0 Item</span>
                <span id="total-bottom" class="font-bold text-sm text-orange-400">Rp 0</span>
            </div>
            <button onclick="toggleCart(true)" class="bg-orange-600 text-white px-8 py-3.5 rounded-2xl font-bold text-xs uppercase active:scale-95 transition-all">Cek Pesanan</button>
        </div>
    </div>

    <div id="cart-sidebar" class="fixed inset-y-0 right-0 w-full md:w-[450px] bg-white shadow-2xl z-[60] translate-x-full transition-transform duration-400 flex flex-col">
        <div class="p-6 flex items-center justify-between border-b">
            <button onclick="handleBack()" class="p-2 text-slate-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
            <h3 class="font-bold text-sm uppercase">Detail Pesanan</h3>
            <button onclick="clearCart()" class="text-[10px] font-bold text-red-500 uppercase bg-red-50 px-3 py-2 rounded-lg">Hapus</button>
        </div>
        <div class="p-4 space-y-4 bg-slate-50 border-b">
            <input type="text" id="user-name" placeholder="Nama Anda..." class="w-full bg-white border border-slate-200 rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-orange-500 font-bold text-sm">
            <div class="grid grid-cols-2 gap-2">
                <button id="opt-takeaway" onclick="setMode('takeaway')" class="py-3 rounded-xl font-bold text-[11px] uppercase border-2 border-orange-500 bg-orange-500 text-white">Take Away</button>
                <button id="opt-delivery" onclick="setMode('delivery')" class="py-3 rounded-xl font-bold text-[11px] uppercase border-2 border-slate-200 bg-white text-slate-400">Delivery</button>
            </div>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar"></div>
        <div class="p-8 border-t bg-slate-50">
            <div class="flex justify-between items-end mb-1">
                <span class="font-bold text-slate-400 text-xs uppercase">Total</span>
                <span id="cart-subtotal" class="text-slate-900 text-xl font-bold">Rp 0</span>
            </div>
            <p id="delivery-info" class="text-[10px] text-orange-600 font-bold text-right mb-6 opacity-0 transition-opacity">*Ongkir akan dikonfirmasi di chat WA</p>
            <button onclick="checkoutWA()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold text-sm shadow-lg active:scale-95 transition-all">PESAN VIA WHATSAPP</button>
        </div>
    </div>

    <div id="overlay" onclick="handleBack()" class="fixed inset-0 bg-black/60 hidden z-50 backdrop-blur-sm opacity-0 transition-opacity"></div>

    <script>
        let menuData = {};
        let cart = JSON.parse(localStorage.getItem('sushieat_cart')) || [];
        let orderMode = 'takeaway';
        let categories = [];
        let currentCatIndex = 0;
        const noWA = "082298232611"; 

        window.addEventListener('load', loadData);
        
        // Logika Back Button Terintegrasi
        window.onpopstate = () => {
            closeLightboxUI();
            closeCartUI();
        };

        async function loadData() {
            try {
                const response = await fetch('menu.json');
                menuData = await response.json();
                categories = Object.keys(menuData);
                renderTabs();
                updateCartUI();
                initSwipe();
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 700);
            } catch (e) { document.getElementById('splash-screen').style.display = 'none'; }
        }

        function renderTabs() {
            const container = document.getElementById('tab-container');
            container.innerHTML = categories.map((cat, index) => `
                <button id="tab-${index}" onclick="switchCategory(${index})" 
                    class="category-chip flex-shrink-0 px-5 py-2.5 rounded-xl font-bold text-xs bg-white text-slate-400 border border-slate-100 uppercase tracking-wide transition-all">
                    ${cat.replace(/_/g, ' ')}
                </button>
            `).join('');
            switchCategory(0);
        }

        function switchCategory(index) {
            currentCatIndex = index;
            document.querySelectorAll('.category-chip').forEach(b => b.classList.remove('active'));
            const activeTab = document.getElementById(`tab-${index}`);
            if(activeTab) {
                activeTab.classList.add('active');
                activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }
            renderMenu(menuData[categories[index]]);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderMenu(items) {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = items.map((item, idx) => `
                <div class="bg-white rounded-3xl p-3 shadow-sm border border-orange-50 flex flex-col active:scale-[0.98] transition-all fade-in" style="animation-delay: ${idx * 0.05}s">
                    <div class="rounded-2xl mb-3 aspect-square bg-slate-50 overflow-hidden" onclick="openLightbox('${item.image}')">
                        <img src="${item.image}" onerror="this.src='https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=400'" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold text-slate-800 text-[11px] uppercase px-1 line-clamp-2 h-8 leading-tight mb-2">${item.name}</h3>
                    <div class="flex items-center justify-between mt-auto px-1">
                        <span class="text-orange-600 font-bold text-sm">Rp${item.price.toLocaleString()}</span>
                        <button onclick="addToCart('${item.name.replace(/'/g, "\\'")}', ${item.price})" class="bg-slate-900 text-white p-2 rounded-xl">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // --- UI Control Functions ---
        function openLightbox(src) {
            const lb = document.getElementById('lightbox');
            document.getElementById('lightbox-img').src = src;
            lb.classList.add('active');
            history.pushState({lightbox: true}, ''); // Push state agar tombol back bisa digunakan
        }

        function closeLightboxUI() {
            document.getElementById('lightbox').classList.remove('active');
        }

        function toggleCart(show) {
            if (show) {
                history.pushState({cart: true}, '');
                openCartUI();
            } else {
                history.back();
            }
        }

        function handleBack() {
            // Jika ada UI yang terbuka, gunakan history.back() untuk memicu onpopstate
            if (document.getElementById('lightbox').classList.contains('active') || 
                document.getElementById('cart-sidebar').style.transform === 'translateX(0px)') {
                history.back();
            }
        }

        function openCartUI() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.style.transform = 'translateX(0)';
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.style.opacity = '1', 10);
        }

        function closeCartUI() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.style.transform = 'translateX(100%)';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        // --- Logic Functions ---
        function addToCart(name, price) {
            const item = cart.find(i => i.name === name);
            if (item) item.quantity++; else cart.push({ name, price, quantity: 1 });
            saveCart(); updateCartUI();
        }

        function updateCartUI() {
            const total = cart.reduce((a, b) => a + (b.price * b.quantity), 0);
            const count = cart.reduce((a, b) => a + b.quantity, 0);
            document.getElementById('cart-count-label').innerText = `${count} Item`;
            document.getElementById('total-bottom').innerText = `Rp ${total.toLocaleString()}`;
            document.getElementById('cart-subtotal').innerText = `Rp ${total.toLocaleString()}`;
            const bar = document.getElementById('bottom-bar');
            if(count > 0) bar.classList.remove('translate-y-32', 'opacity-0');
            else bar.classList.add('translate-y-32', 'opacity-0');
            document.getElementById('cart-items').innerHTML = cart.map((item, i) => `
                <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl">
                    <div class="flex-1">
                        <h4 class="font-bold text-[11px] uppercase text-slate-700">${item.name}</h4>
                        <p class="text-orange-600 font-bold text-sm mt-0.5">Rp ${(item.price * item.quantity).toLocaleString()}</p>
                    </div>
                    <div class="flex items-center gap-3 bg-white px-3 py-1.5 rounded-xl border">
                        <button onclick="updateQty(${i}, -1)" class="font-bold text-slate-300">-</button>
                        <span class="font-bold text-sm">${item.quantity}</span>
                        <button onclick="updateQty(${i}, 1)" class="font-bold text-orange-600">+</button>
                    </div>
                </div>
            `).join('');
        }

        function updateQty(i, c) { if (cart[i].quantity + c > 0) cart[i].quantity += c; else cart.splice(i, 1); saveCart(); updateCartUI(); }
        function saveCart() { localStorage.setItem('sushieat_cart', JSON.stringify(cart)); }
        function clearCart() { if(confirm('Hapus semua pesanan?')) { cart = []; saveCart(); updateCartUI(); handleBack(); } }

        function toggleSearch() {
            const s = document.getElementById('search-container');
            const isOpen = !s.classList.contains('-translate-y-full');
            if (isOpen) s.classList.add('-translate-y-full', 'opacity-0', 'pointer-events-none');
            else { s.classList.remove('-translate-y-full', 'opacity-0', 'pointer-events-none'); document.getElementById('search-input').focus(); }
        }

        function searchMenu() {
            const q = document.getElementById('search-input').value.toLowerCase();
            let flat = []; Object.values(menuData).forEach(cat => flat = [...flat, ...cat]);
            renderMenu(flat.filter(i => i.name.toLowerCase().includes(q)));
        }

        function setMode(mode) {
            orderMode = mode;
            document.getElementById('delivery-info').style.opacity = (mode === 'delivery') ? '1' : '0';
            document.getElementById('opt-takeaway').className = (mode === 'takeaway') ? "py-3 rounded-xl font-bold text-[11px] uppercase border-2 border-orange-500 bg-orange-500 text-white" : "py-3 rounded-xl font-bold text-[11px] uppercase border-2 border-slate-200 bg-white text-slate-400";
            document.getElementById('opt-delivery').className = (mode === 'delivery') ? "py-3 rounded-xl font-bold text-[11px] uppercase border-2 border-orange-500 bg-orange-500 text-white" : "py-3 rounded-xl font-bold text-[11px] uppercase border-2 border-slate-200 bg-white text-slate-400";
        }

        function initSwipe() {
            let startX = 0;
            const area = document.getElementById('swipe-area');
            area.addEventListener('touchstart', e => startX = e.touches[0].clientX, {passive: true});
            area.addEventListener('touchend', e => {
                let diff = startX - e.changedTouches[0].clientX;
                if (Math.abs(diff) > 100) {
                    if (diff > 0 && currentCatIndex < categories.length - 1) switchCategory(currentCatIndex + 1);
                    else if (diff < 0 && currentCatIndex > 0) switchCategory(currentCatIndex - 1);
                }
            }, {passive: true});
        }

        function checkoutWA() {
            const name = document.getElementById('user-name').value.trim();
            if (!name) return alert("Boleh tau nama kakak siapa? ðŸ˜Š");
            if (cart.length === 0) return;

            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const total = cart.reduce((a, b) => a + (b.price * b.quantity), 0);
            const metode = (orderMode === 'delivery') ? 'Delivery' : 'Take Away';

            let msg = `Halo, mau order Sushi Eat.\n`;
            msg += `ðŸ‘¤ *Nama:* ${name}\n`;
            msg += `ðŸ“¦ *Metode:* ${metode}\n\n`;
            msg += `*Daftar Pesanan:*\n`;
            
            cart.forEach((item, index) => {
                msg += `${index + 1}. ${item.name} (${item.quantity}x)\n`;
            });

            msg += `\nðŸ’° *Total Belanja: Rp ${total.toLocaleString()}*\n`;
            msg += `Pesanan ini dikirim jam ${timeStr}. Mohon dicek kak, terima kasih banyak!`;

            window.open(`https://wa.me/${noWA}?text=${encodeURIComponent(msg)}`);
        }
    </script>
</body>
</html>